###
# Redis Microservice - REST Client Examples
#
# This file contains example HTTP requests for testing the Redis microservice.
# Use with VS Code REST Client extension or similar tools.
#
# To use these examples:
# 1. For JWT authentication (REST endpoints):
#    - Generate a JWT token: node generate-test-token.js [username] [role]
#      Example: node generate-test-token.js alice user
#    - Replace <your-jwt-token-here> below with your token
# 2. For API key authentication (Redis proxy):
#    - Add your XANO_API_KEY to .env file
#    - Replace <your-api-key-here> below with your API key
# 3. Click "Send Request" above each request
#
# AUTHENTICATION NOTES:
# - JWT tokens are used for REST endpoints (users, posts, feeds)
# - API keys are used for Redis proxy endpoints (backend sync only)
# - Frontend developers should use REST endpoints, not Redis proxy
###

###############################################################################
# MIGRATION NOTICE (November 2025)
###############################################################################
# Redis proxy endpoints (POST / and POST /redis/write) now require API key.
# Frontend clients should use REST endpoints instead:
#   - GET /users/me instead of POST / with ["HGETALL", "user:me"]
#   - PATCH /users/me instead of POST /redis/write with ["HSET", "user:me", ...]
#   - POST /posts/:id/like instead of direct Redis commands
# See docs/FRONTEND_GUIDE.md for complete migration guide.
###############################################################################

### Variables
@baseUrl = http://localhost:3000
@token = <your-jwt-token-here>
@apiKey = <your-api-key-here>

###############################################################################
# PUBLIC ENDPOINTS (No Authentication Required)
###############################################################################

### GET / - Welcome message
GET {{baseUrl}}/

### GET /ping - Health check
GET {{baseUrl}}/ping

### GET /healthz - Health status
GET {{baseUrl}}/healthz

###############################################################################
# PROTECTED ENDPOINTS (JWT Authentication Required)
###############################################################################

### GET /whoami - View JWT payload
GET {{baseUrl}}/whoami
Authorization: Bearer {{token}}

### POST /whoami - View JWT payload (POST method)
POST {{baseUrl}}/whoami
Authorization: Bearer {{token}}

### GET /debug-auth - Test key resolution
GET {{baseUrl}}/debug-auth
Authorization: Bearer {{token}}

### POST /debug-auth - Test key resolution
POST {{baseUrl}}/debug-auth
Authorization: Bearer {{token}}

###############################################################################
# REDIS PROXY ENDPOINTS (API KEY ONLY)
###############################################################################
# These endpoints require API key authentication (X-API-Key header)
# Used for backend synchronization (Xano) only
# Frontend clients should use REST endpoints instead (see sections below)
# The user:me placeholder resolves to user:xano_sync for API key requests

### Redis HGETALL - Get user data (API key)
POST {{baseUrl}}/
X-API-Key: {{apiKey}}
Content-Type: application/json

[["HGETALL", "user:alice"]]

### Redis SMEMBERS - Get user followers (API key)
POST {{baseUrl}}/
X-API-Key: {{apiKey}}
Content-Type: application/json

[["SMEMBERS", "user:alice:followers"]]

### Redis ZREVRANGE - Get user posts (API key)
POST {{baseUrl}}/
X-API-Key: {{apiKey}}
Content-Type: application/json

[["ZREVRANGE", "user:alice:posts", "0", "9"]]

### Redis MGET - Get multiple users (batch operation with API key)
POST {{baseUrl}}/
X-API-Key: {{apiKey}}
Content-Type: application/json

[["HGETALL", "user:alice"], ["HGETALL", "user:bob"]]

### ERROR: JWT authentication not allowed for Redis proxy (403 Forbidden)
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["HGETALL", "user:alice"]]

### ERROR: Invalid API key (401 Unauthorized)
POST {{baseUrl}}/
X-API-Key: invalid-key
Content-Type: application/json

[["HGETALL", "user:alice"]]

###############################################################################
# REDIS WRITE PROXY (API KEY ONLY)
###############################################################################
# Write operations require API key authentication
# Used for backend synchronization (Xano) only
# Frontend clients should use REST endpoints instead (PATCH /users/:id, etc.)
# Supports efficient multi-field HSET syntax (Upstash-style)

### SUCCESS: HSET - Update user bio (single field)
POST {{baseUrl}}/redis/write
X-API-Key: {{apiKey}}
Content-Type: application/json

[["HSET", "user:alice", "bio", "Updated from Xano"]]

### SUCCESS: Batch update multiple users (traditional)
POST {{baseUrl}}/redis/write
X-API-Key: {{apiKey}}
Content-Type: application/json

[
  ["HSET", "user:alice", "bio", "Bio 1"],
  ["HSET", "user:bob", "bio", "Bio 2"]
]

###############################################################################
# EFFICIENT HSET SYNTAX (MULTIPLE FIELDS)
###############################################################################
# HSET supports multiple field-value pairs in a single command (Upstash-style)
# This is more efficient than sending multiple HSET commands
# Syntax: ["HSET", "key", "field1", "value1", "field2", "value2", ...]
#
# Quick Reference:
# - Single command (Upstash-style): ["HSET", "user:alice", "bio", "Updated bio"]
# - Single field: ["HSET", "key", "field", "value"]
# - Multiple fields: ["HSET", "key", "f1", "v1", "f2", "v2", "f3", "v3"]
# - Multiple commands: [["HSET", ...], ["HSET", ...]]
# Note: Write proxy is scoped to user:* keys only (HSET, HDEL, HINCRBY)

### UPSTASH-STYLE: Single command array (no nesting)
POST {{baseUrl}}/redis/write
X-API-Key: {{apiKey}}
Content-Type: application/json

["HSET", "user:alice", "email", "mail@user123.com", "likeCount", "0"]

### EFFICIENT: HSET - Multiple fields (recommended)
POST {{baseUrl}}/redis/write
X-API-Key: {{apiKey}}
Content-Type: application/json

[[
  "HSET", "user:alice",
  "bio", "Software developer and tech enthusiast",
  "email", "alice@example.com",
  "phone", "+1-555-0123",
  "links", "https://alice.dev"
]]

### EFFICIENT: HSET - Many fields (bulk update)
POST {{baseUrl}}/redis/write
X-API-Key: {{apiKey}}
Content-Type: application/json

[[
  "HSET", "user:bob",
  "bio", "Product designer",
  "email", "bob@example.com",
  "phone", "+1-555-0124",
  "links", "https://bob.design",
  "created_at", "1234567890123",
  "postCount", "0",
  "followerCount", "0",
  "followingCount", "0"
]]

### ERROR: Blocked field in multi-field HSET
# Should return error: "ERR field 'username' cannot be modified directly"
POST {{baseUrl}}/redis/write
X-API-Key: {{apiKey}}
Content-Type: application/json

[[
  "HSET", "user:alice",
  "bio", "New bio",
  "username", "alice_new",
  "email", "alice@example.com"
]]

### ERROR: Multiple blocked fields
# Should return error mentioning blocked fields
POST {{baseUrl}}/redis/write
X-API-Key: {{apiKey}}
Content-Type: application/json

[[
  "HSET", "user:alice",
  "bio", "New bio",
  "username", "alice_new",
  "role", "admin",
  "display_name", "Alice Smith"
]]

### ERROR: Missing value in field-value pairs
# Should return error: "ERR HSET requires field-value pairs"
POST {{baseUrl}}/redis/write
X-API-Key: {{apiKey}}
Content-Type: application/json

[[
  "HSET", "user:alice",
  "bio", "New bio",
  "email"
]]

###############################################################################
# PERFORMANCE COMPARISON
###############################################################################

### COMPARISON - Inefficient: Multiple HSET commands
# 7 Redis commands, 7 network round trips
POST {{baseUrl}}/redis/write
X-API-Key: {{apiKey}}
Content-Type: application/json

[
  ["HSET", "user:charlie", "username", "charlie"],
  ["HSET", "user:charlie", "display_name", "Charlie Brown"],
  ["HSET", "user:charlie", "bio", "Software engineer"],
  ["HSET", "user:charlie", "avatar", "https://example.com/charlie.jpg"],
  ["HSET", "user:charlie", "email", "charlie@example.com"],
  ["HSET", "user:charlie", "phone", "+1-555-0125"],
  ["HSET", "user:charlie", "created_at", "1234567890123"]
]

### COMPARISON - Efficient: Single HSET with multiple fields
# 1 Redis command, 1 network round trip, atomic operation
# Result: 7x reduction in Redis commands and network overhead
# Recommended for bulk field updates
POST {{baseUrl}}/redis/write
X-API-Key: {{apiKey}}
Content-Type: application/json

[[
  "HSET", "user:charlie",
  "username", "charlie",
  "display_name", "Charlie Brown",
  "bio", "Software engineer",
  "avatar", "https://example.com/charlie.jpg",
  "email", "charlie@example.com",
  "phone", "+1-555-0125",
  "created_at", "1234567890123"
]]

### PERFORMANCE - Batch update multiple users efficiently
# Updates 3 users with 3 fields each
# Total: 3 Redis commands (one per user)
# Old way would require 9 Redis commands (3 fields Ã— 3 users)
POST {{baseUrl}}/redis/write
X-API-Key: {{apiKey}}
Content-Type: application/json

[
  [
    "HSET", "user:alice",
    "bio", "Updated bio 1",
    "email", "alice@example.com",
    "phone", "+1-555-0123"
  ],
  [
    "HSET", "user:bob",
    "bio", "Updated bio 2",
    "email", "bob@example.com",
    "phone", "+1-555-0124"
  ],
  [
    "HSET", "user:charlie",
    "bio", "Updated bio 3",
    "email", "charlie@example.com",
    "phone", "+1-555-0125"
  ]
]

### ERROR: JWT authentication not allowed for write proxy (403 Forbidden)
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HSET", "user:alice", "bio", "New bio"]]

###############################################################################
# ERROR EXAMPLES FOR REST ENDPOINTS
###############################################################################

### ERROR: No token provided (401 Unauthorized)
GET {{baseUrl}}/users/alice

### ERROR: Invalid token (401 Unauthorized)
GET {{baseUrl}}/users/alice
Authorization: Bearer invalid-token-here


###############################################################################
# ALTERNATIVE AUTHENTICATION HEADERS
###############################################################################

### Using x-authorization header
POST {{baseUrl}}/whoami
x-authorization: {{token}}

### Using x-access-token header
POST {{baseUrl}}/whoami
x-access-token: {{token}}

###############################################################################
# FEED ENDPOINTS
###############################################################################

### GET /feed/explore - Explore feed (first page, default pagination)
# Returns posts from the global explore:feed sorted set
# Response: { posts: [{ post: {...}, user: {...} }], pagination: { offset, limit, count } }
GET {{baseUrl}}/feed/explore
Authorization: Bearer {{token}}

### GET /feed/explore - Explore feed with custom pagination (first 10 posts)
GET {{baseUrl}}/feed/explore?offset=0&limit=10
Authorization: Bearer {{token}}

### GET /feed/explore - Explore feed (second page, posts 11-20)
GET {{baseUrl}}/feed/explore?offset=10&limit=10
Authorization: Bearer {{token}}

### GET /feed/explore - Explore feed (only 5 posts)
GET {{baseUrl}}/feed/explore?limit=5
Authorization: Bearer {{token}}

### GET /feed/following - Following feed (first page, default pagination)
# Returns posts from users that the authenticated user follows
# User-specific based on JWT user_id
# Response: { posts: [{ post: {...}, user: {...} }], pagination: { offset, limit, count } }
GET {{baseUrl}}/feed/following
Authorization: Bearer {{token}}

### GET /feed/following - Following feed with custom pagination (first 10 posts)
GET {{baseUrl}}/feed/following?offset=0&limit=10
Authorization: Bearer {{token}}

### GET /feed/following - Following feed (second page, posts 11-20)
GET {{baseUrl}}/feed/following?offset=10&limit=10
Authorization: Bearer {{token}}

### GET /feed/following - Following feed (only 5 posts)
GET {{baseUrl}}/feed/following?limit=5
Authorization: Bearer {{token}}

### GET /feed/explore - Explore feed WITHOUT user data (faster)
GET {{baseUrl}}/feed/explore?limit=10&includeUser=false
Authorization: Bearer {{token}}

### GET /feed/following - Following feed WITHOUT user data (faster)
GET {{baseUrl}}/feed/following?limit=10&includeUser=false
Authorization: Bearer {{token}}

###############################################################################
# USER PROFILE ENDPOINTS
###############################################################################

### GET /users/me - Get your own profile (all fields visible)
GET {{baseUrl}}/users/me
Authorization: Bearer {{token}}

### GET /users/:username - Get another user's profile (sensitive fields removed)
GET {{baseUrl}}/users/alice
Authorization: Bearer {{token}}

### GET /users/:username - Get another user's profile
GET {{baseUrl}}/users/bob
Authorization: Bearer {{token}}

### PATCH /users/me - Update your own profile
PATCH {{baseUrl}}/users/me
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "bio": "Updated bio from REST endpoint",
  "links": "https://example.com"
}

### PATCH /users/:username - Update specific fields
PATCH {{baseUrl}}/users/alice
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "bio": "New bio",
  "email": "newemail@example.com"
}

### ERROR: GET /users/:username - User not found (404)
GET {{baseUrl}}/users/nonexistent-user
Authorization: Bearer {{token}}

### ERROR: PATCH other user's profile (403 Forbidden)
PATCH {{baseUrl}}/users/bob
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "bio": "Trying to update someone else's profile"
}

###############################################################################
# FEED ENDPOINTS - EXPECTED RESPONSE FORMAT
###############################################################################

# Example response structure for feed endpoints:
# {
#   "posts": [
#     {
#       "post": {
#         "uuid": "post-uuid-123",
#         "user_id": "user-uuid-456",
#         "content": "Example post content",
#         "created_at": "2025-11-02T10:30:00Z",
#         ... (other post fields from Redis hash)
#       },
#       "user": {
#         "uuid": "user-uuid-456",
#         "username": "johndoe",
#         "display_name": "John Doe",
#         ... (other user fields from Redis hash)
#       }
#     }
#   ],
#   "pagination": {
#     "offset": 0,
#     "limit": 20,
#     "count": 15
#   }
# }
