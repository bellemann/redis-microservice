###
# Redis Microservice - REST Client Examples
#
# This file contains example HTTP requests for testing the Redis microservice.
# Use with VS Code REST Client extension or similar tools.
#
# To use these examples:
# 1. Generate a JWT token: node generate-test-token.js [user_id] [role]
#    Example: node generate-test-token.js 123 user
# 2. Replace <your-jwt-token-here> below with your token
# 3. Click "Send Request" above each request
###

### Variables
@baseUrl = http://localhost:3000
@token = <your-jwt-token-here>

###############################################################################
# PUBLIC ENDPOINTS (No Authentication Required)
###############################################################################

### GET / - Welcome message
GET {{baseUrl}}/

### GET /ping - Health check
GET {{baseUrl}}/ping

### GET /healthz - Health status
GET {{baseUrl}}/healthz

###############################################################################
# PROTECTED ENDPOINTS (JWT Authentication Required)
###############################################################################

### GET /whoami - View JWT payload
GET {{baseUrl}}/whoami
Authorization: Bearer {{token}}

### POST /whoami - View JWT payload (POST method)
POST {{baseUrl}}/whoami
Authorization: Bearer {{token}}

### GET /debug-auth - Test key resolution
GET {{baseUrl}}/debug-auth
Authorization: Bearer {{token}}

### POST /debug-auth - Test key resolution
POST {{baseUrl}}/debug-auth
Authorization: Bearer {{token}}

###############################################################################
# REDIS PROXY ENDPOINTS
###############################################################################

### Redis GET - Get user's following list (with placeholder)
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["GET", "user:AUTH:following"]]

### Redis HGETALL - Get user hash data
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["HGETALL", "user:AUTH"]]

### Redis SMEMBERS - Get set members (followers)
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["SMEMBERS", "user:AUTH:followers"]]

### Redis HGET - Get specific hash field
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["HGET", "user:AUTH", "name"]]

### Redis MGET - Get multiple keys
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["MGET", "user:AUTH:posts_count", "user:AUTH:followers_count"]]

### Redis EXISTS - Check if key exists
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["EXISTS", "user:AUTH:following"]]

### Redis ZRANGE - Query leaderboard (public data)
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["ZRANGE", "leaderboard", "0", "10"]]

### Redis LRANGE - Get list range
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["LRANGE", "user:AUTH:notifications", "0", "10"]]

### Redis TTL - Check key expiration
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["TTL", "user:AUTH:session"]]

### Redis TYPE - Get key type
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["TYPE", "user:AUTH:following"]]

###############################################################################
# ERROR EXAMPLES
###############################################################################

### ERROR: No token provided (401 Unauthorized)
POST {{baseUrl}}/
Content-Type: application/json

[["GET", "user:AUTH:following"]]

### ERROR: Invalid token (401 Unauthorized)
POST {{baseUrl}}/
Authorization: Bearer invalid-token-here
Content-Type: application/json

[["GET", "user:AUTH:following"]]

### ERROR: Access to other user's data (403 Forbidden)
# Assuming your user_id is 123, trying to access user:456:*
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["GET", "user:456:following"]]

### ERROR: Write command blocked (Read-only mode)
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["SET", "user:AUTH:test", "value"]]

### ERROR: Delete command blocked (Read-only mode)
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["DEL", "user:AUTH:test"]]

### ERROR: Sensitive key access (403 Forbidden)
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["GET", "otp:123456"]]

### ERROR: Session key access (403 Forbidden)
POST {{baseUrl}}/
Authorization: Bearer {{token}}
Content-Type: application/json

[["GET", "session:abc123"]]

###############################################################################
# REDIS WRITE PROXY ENDPOINT
###############################################################################
# This endpoint allows authenticated users to perform safe write operations
# on their own user data using the AUTH placeholder.
#
# Allowed commands: HSET, HDEL, HINCRBY
# Allowed keys: user:AUTH (automatically replaced with user:<your_user_id>)
#
# Blocked fields (require PATCH /users/:id for denormalization):
#   - username, display_name, avatar
#   - role, postCount, followerCount, followingCount (system-managed)
#
# Allowed fields: bio, links, and any custom fields
###############################################################################

### SUCCESS: HSET - Update bio field
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HSET", "user:AUTH", "bio", "My new bio updated via Redis write proxy"]]

### SUCCESS: HSET - Update links field
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HSET", "user:AUTH", "links", "https://example.com"]]

### SUCCESS: HSET - Add custom field
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HSET", "user:AUTH", "custom_field", "custom_value"]]

### SUCCESS: HINCRBY - Increment custom counter
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HINCRBY", "user:AUTH", "custom_counter", "1"]]

### SUCCESS: HDEL - Delete custom field
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HDEL", "user:AUTH", "custom_field"]]

### SUCCESS: Multiple commands in one request
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HSET", "user:AUTH", "bio", "New bio"], ["HSET", "user:AUTH", "links", "https://example.com"]]

### ERROR: Blocked command (ZADD)
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["ZADD", "user:AUTH:posts", "123", "post-id"]]

### ERROR: Blocked command (DEL)
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["DEL", "user:AUTH"]]

### ERROR: Blocked command (SET)
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["SET", "user:AUTH:token", "secret"]]

### ERROR: Blocked field (username)
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HSET", "user:AUTH", "username", "newusername"]]

### ERROR: Blocked field (display_name)
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HSET", "user:AUTH", "display_name", "New Name"]]

### ERROR: Blocked field (avatar)
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HSET", "user:AUTH", "avatar", "https://new-avatar.com/image.jpg"]]

### ERROR: Blocked field (role)
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HSET", "user:AUTH", "role", "admin"]]

### ERROR: Blocked field (postCount)
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HSET", "user:AUTH", "postCount", "9999"]]

### ERROR: HDEL blocked field (username)
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HDEL", "user:AUTH", "username"]]

### ERROR: HINCRBY blocked field (postCount)
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HINCRBY", "user:AUTH", "postCount", "1"]]

### ERROR: HINCRBY blocked field (role)
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HINCRBY", "user:AUTH", "role", "1"]]

### ERROR: HINCRBY blocked field (followerCount)
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HINCRBY", "user:AUTH", "followerCount", "10"]]

### ERROR: Accessing other user's data (explicit user ID)
# Note: Replace 'other-user-id-123' with an actual different user ID
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HSET", "user:other-user-id-123", "bio", "Hacked"]]

### ERROR: Invalid key format (non-user key)
POST {{baseUrl}}/redis/write
Authorization: Bearer {{token}}
Content-Type: application/json

[["HSET", "somekey", "field", "value"]]

###############################################################################
# ALTERNATIVE AUTHENTICATION HEADERS
###############################################################################

### Using x-authorization header
POST {{baseUrl}}/whoami
x-authorization: {{token}}

### Using x-access-token header
POST {{baseUrl}}/whoami
x-access-token: {{token}}

###############################################################################
# FEED ENDPOINTS
###############################################################################

### GET /feed/explore - Explore feed (first page, default pagination)
# Returns posts from the global explore:feed sorted set
# Response: { posts: [{ post: {...}, user: {...} }], pagination: { offset, limit, count } }
GET {{baseUrl}}/feed/explore
Authorization: Bearer {{token}}

### GET /feed/explore - Explore feed with custom pagination (first 10 posts)
GET {{baseUrl}}/feed/explore?offset=0&limit=10
Authorization: Bearer {{token}}

### GET /feed/explore - Explore feed (second page, posts 11-20)
GET {{baseUrl}}/feed/explore?offset=10&limit=10
Authorization: Bearer {{token}}

### GET /feed/explore - Explore feed (only 5 posts)
GET {{baseUrl}}/feed/explore?limit=5
Authorization: Bearer {{token}}

### GET /feed/following - Following feed (first page, default pagination)
# Returns posts from users that the authenticated user follows
# User-specific based on JWT user_id
# Response: { posts: [{ post: {...}, user: {...} }], pagination: { offset, limit, count } }
GET {{baseUrl}}/feed/following
Authorization: Bearer {{token}}

### GET /feed/following - Following feed with custom pagination (first 10 posts)
GET {{baseUrl}}/feed/following?offset=0&limit=10
Authorization: Bearer {{token}}

### GET /feed/following - Following feed (second page, posts 11-20)
GET {{baseUrl}}/feed/following?offset=10&limit=10
Authorization: Bearer {{token}}

### GET /feed/following - Following feed (only 5 posts)
GET {{baseUrl}}/feed/following?limit=5
Authorization: Bearer {{token}}

### GET /feed/explore - Explore feed WITHOUT user data (faster)
GET {{baseUrl}}/feed/explore?limit=10&includeUser=false
Authorization: Bearer {{token}}

### GET /feed/following - Following feed WITHOUT user data (faster)
GET {{baseUrl}}/feed/following?limit=10&includeUser=false
Authorization: Bearer {{token}}

###############################################################################
# USER PROFILE ENDPOINT
###############################################################################

### GET /users/:id - Get your own profile (all fields visible)
# Replace "your-user-id" with your actual user ID from the JWT token
GET {{baseUrl}}/users/your-user-id
Authorization: Bearer {{token}}

### GET /users/:id - Get another user's profile (sensitive fields removed)
# Replace "other-user-id" with another user's ID
GET {{baseUrl}}/users/other-user-id
Authorization: Bearer {{token}}

### GET /users/:id - Get user profile (example with UUID)
GET {{baseUrl}}/users/123e4567-e89b-12d3-a456-426614174000
Authorization: Bearer {{token}}

### ERROR: GET /users/:id - User not found (404)
GET {{baseUrl}}/users/nonexistent-user-id
Authorization: Bearer {{token}}

###############################################################################
# FEED ENDPOINTS - EXPECTED RESPONSE FORMAT
###############################################################################

# Example response structure for feed endpoints:
# {
#   "posts": [
#     {
#       "post": {
#         "uuid": "post-uuid-123",
#         "user_id": "user-uuid-456",
#         "content": "Example post content",
#         "created_at": "2025-11-02T10:30:00Z",
#         ... (other post fields from Redis hash)
#       },
#       "user": {
#         "uuid": "user-uuid-456",
#         "username": "johndoe",
#         "display_name": "John Doe",
#         ... (other user fields from Redis hash)
#       }
#     }
#   ],
#   "pagination": {
#     "offset": 0,
#     "limit": 20,
#     "count": 15
#   }
# }
